version: '2'
x-es-environment-defaults:
  C1: &DISCOVERY_SEED_HOSTS "discovery.seed_hosts=es_master_1:9300,es_master_2:9300,es_master_3:9300,es_data_1:9300,es_data_2:9300,es_data_3:9300"
  C2: &CLUSTER_INITIAL_MASTER_NODES "cluster.initial_master_nodes=es_master_1:9300,es_master_2:9300,es_master_3:9300"
  C3: &DISCOVERY_ZEN_MINIMUM_MASTER_NODES "discovery.zen.minimum_master_nodes=2"
  C4: &ES_JAVA_OPTS "ES_JAVA_OPTS=\
      -Xms256m \
      -Xmx256m \
    "

x-es-ulimit-defaults: &ES_ULIMIT_DEFAULTS
  nproc: 65535
  nofile:
    soft: 65535
    hard: 65535
  memlock:
    soft: -1
    hard: -1

networks:
  net:
    driver: "bridge"

volumes:
  es_vol_m_1_logs:
    driver: "local"
  es_vol_m_1_data:
    driver: "local"
  es_vol_m_2_logs:
    driver: "local"
  es_vol_m_2_data:
    driver: "local"
  es_vol_m_3_logs:
    driver: "local"
  es_vol_m_3_data:
    driver: "local"
  es_vol_d_1_logs:
    driver: "local"
  es_vol_d_1_data:
    driver: "local"
  es_vol_d_2_logs:
    driver: "local"
  es_vol_d_2_data:
    driver: "local"
  es_vol_d_3_logs:
    driver: "local"
  es_vol_d_3_data:
    driver: "local"

services:
  kibana:
    image: "kibana:7.0.0"
    container_name: "kibana"
    hostname: "kibana"
    depends_on:
      - "es_data_1"
      - "es_data_2"
      - "es_data_3"
    networks:
      - "net"
    ports:
      - "5601:5601"
    environment:
      - SERVER_PORT=5601
      - SERVER_HOST=0.0.0.0
      - SERVER_NAME=es_cluster
      - ELASTICSEARCH_HOSTS=es_master_1:9201,es_master_2:9202,es_master_3:9203,es_data_1:9211,es_data_2:9212,es_data_3:9213
      - KIBANA_INDEX=.kibana
      - DIBANA_DEFAULTAPPID=home
      - ELASTICSEARCH_PINGTIMEOUT=1500
      - ELASTICSEARCH_REQUESTTIMEOUT=10000
      - ELASTICSEARCH_LOGQUERIES=false
  filebeat:
    image: "elastic/filebeat:7.0.0"
    container_name: "filebeat"
    hostname: "filebeat"
    depends_on:
      - "es_data_1"
      - "es_data_2"
      - "es_data_3"
    networks:
      - "net"
    volumes:
      - /private/tmp/filebeat.yaml:/usr/share/filebeat/filebeat.yml
      - /private/tmp/logs/app:/tmp/app/logs
    environment:
      - output.elasticsearch.hosts=es_master_1:9201,es_master_2:9202,es_master_3:9203,es_data_1:9211,es_data_2:9212,es_data_3:9213
      - logging.level=debug
  es_master_1:
    image: "elasticsearch:7.0.0"
    container_name: "es_master_1"
    hostname: "es_master_1"
    volumes:
      - es_vol_m_1_data:/tmp/elk/es/data
      - es_vol_m_1_logs:/tmp/elk/es/logs
      - /private/tmp/elasticsearch.yaml:/usr/share/elasticsearch/config/elasticsearch.yml
    networks:
      - "net"
    ports:
      - "9201:9201"
    expose:
      - "9300"
    environment:
      - node.name=es_master_1
      - http.port=9201
      - node.master=true
      - node.data=false
      - *DISCOVERY_SEED_HOSTS
      - *CLUSTER_INITIAL_MASTER_NODES
      - *DISCOVERY_ZEN_MINIMUM_MASTER_NODES
      - *ES_JAVA_OPTS
    ulimits:
      <<: *ES_ULIMIT_DEFAULTS
  es_master_2:
    image: "elasticsearch:7.0.0"
    container_name: "es_master_2"
    hostname: "es_master_2"
    volumes:
      - es_vol_m_2_data:/tmp/elk/es/data
      - es_vol_m_2_logs:/tmp/elk/es/logs
      - /private/tmp/elasticsearch.yaml:/usr/share/elasticsearch/config/elasticsearch.yml
    networks:
      - "net"
    ports:
      - "9202:9202"
    expose:
      - "9300"
    environment:
      - node.name=es_master_2
      - http.port=9202
      - node.master=true
      - node.data=false
      - *DISCOVERY_SEED_HOSTS
      - *CLUSTER_INITIAL_MASTER_NODES
      - *DISCOVERY_ZEN_MINIMUM_MASTER_NODES
      - *ES_JAVA_OPTS
    ulimits:
      <<: *ES_ULIMIT_DEFAULTS
  es_master_3:
    image: "elasticsearch:7.0.0"
    container_name: "es_master_3"
    hostname: "es_master_3"
    volumes:
      - es_vol_m_3_data:/tmp/elk/es/data
      - es_vol_m_3_logs:/tmp/elk/es/logs
      - /private/tmp/elasticsearch.yaml:/usr/share/elasticsearch/config/elasticsearch.yml
    networks:
      - "net"
    ports:
      - "9203:9203"
    expose:
      - "9300"
    environment:
      - node.name=es_master_3
      - http.port=9203
      - node.master=true
      - node.data=false
      - *DISCOVERY_SEED_HOSTS
      - *CLUSTER_INITIAL_MASTER_NODES
      - *DISCOVERY_ZEN_MINIMUM_MASTER_NODES
      - *ES_JAVA_OPTS
    ulimits:
      <<: *ES_ULIMIT_DEFAULTS
  es_data_1:
    image: "elasticsearch:7.0.0"
    container_name: "es_data_1"
    hostname: "es_data_1"
    depends_on:
      - "es_master_1"
      - "es_master_2"
      - "es_master_3"
    volumes:
      - es_vol_d_1_data:/tmp/elk/es/data
      - es_vol_d_1_logs:/tmp/elk/es/logs
      - /private/tmp/elasticsearch.yaml:/usr/share/elasticsearch/config/elasticsearch.yml
    networks:
      - "net"
    ports:
      - "9211:9211"
    expose:
      - "9300"
    environment:
      - node.name=es_data_1
      - http.port=9211
      - node.master=false
      - node.data=true
      - *DISCOVERY_SEED_HOSTS
      - *CLUSTER_INITIAL_MASTER_NODES
      - *DISCOVERY_ZEN_MINIMUM_MASTER_NODES
      - *ES_JAVA_OPTS
    ulimits:
      <<: *ES_ULIMIT_DEFAULTS
  es_data_2:
    image: "elasticsearch:7.0.0"
    container_name: "es_data_2"
    hostname: "es_data_2"
    depends_on:
      - "es_master_1"
      - "es_master_2"
      - "es_master_3"
    volumes:
      - es_vol_d_2_data:/tmp/elk/es/data
      - es_vol_d_2_logs:/tmp/elk/es/logs
      - /private/tmp/elasticsearch.yaml:/usr/share/elasticsearch/config/elasticsearch.yml
    networks:
      - "net"
    ports:
      - "9212:9212"
    expose:
      - "9300"
    environment:
      - node.name=es_data_2
      - http.port=9212
      - node.master=false
      - node.data=true
      - *DISCOVERY_SEED_HOSTS
      - *CLUSTER_INITIAL_MASTER_NODES
      - *DISCOVERY_ZEN_MINIMUM_MASTER_NODES
      - *ES_JAVA_OPTS
    ulimits:
      <<: *ES_ULIMIT_DEFAULTS
  es_data_3:
    image: "elasticsearch:7.0.0"
    container_name: "es_data_3"
    hostname: "es_data_3"
    depends_on:
      - "es_master_1"
      - "es_master_2"
      - "es_master_3"
    volumes:
      - es_vol_d_3_data:/tmp/elk/es/data
      - es_vol_d_3_logs:/tmp/elk/es/logs
      - /private/tmp/elasticsearch.yaml:/usr/share/elasticsearch/config/elasticsearch.yml
    networks:
      - "net"
    ports:
      - "9213:9213"
    expose:
      - "9300"
    environment:
      - node.name=es_data_3
      - http.port=9213
      - node.master=false
      - node.data=true
      - *DISCOVERY_SEED_HOSTS
      - *CLUSTER_INITIAL_MASTER_NODES
      - *DISCOVERY_ZEN_MINIMUM_MASTER_NODES
      - *ES_JAVA_OPTS
    ulimits:
      <<: *ES_ULIMIT_DEFAULTS